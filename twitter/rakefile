require 'rake/clean'

SRC = "*.go"
LIB = "./pkg/*.go"

bin_src_list = FileList.new(SRC)
bin_list = bin_src_list.ext("")
lib_src_list = FileList.new(LIB)
lib_list = lib_src_list.ext("6")
include_list = FileList.new(`echo $GOPATH`.strip.split ':')

include_opt = include_list.to_ary.map { |f| "-I \"#{f}/pkg/darwin_amd64\"" }.join(" ")
library_opt = include_list.to_ary.map { |f| "-L \"#{f}/pkg/darwin_amd64\"" }.join(" ")

task :default => [:lib, :bin]

task :bin => [:lib, *bin_list]

task :lib => lib_list

rule '.6' => '.go' do |t|
  sh "go tool 6g #{include_opt} -o \"#{t.name}\" \"#{t.source}\""
end

bin_list.each do |bin|
  rule bin => ".go" do |t|
    sh "go tool 6g #{include_opt} -o \"#{t.name}.6\" \"#{t.source}\""
    sh "go tool 6l #{library_opt} -o \"#{t.name}\" \"#{t.name}.6\""
  end
end

CLEAN.include(lib_list)
CLEAN.include(bin_list)
CLEAN.include(bin_list.ext("6"))
