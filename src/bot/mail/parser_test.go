package mail

import (
	"bytes"
	"fmt"
	"github.com/stretchrcom/testify/assert"
	"model"
	"net/mail"
	"testing"
)

var config model.Config

func init() {
	config.Email.Prefix = "x"
	config.Email.Domain = "0d0f.com"
}

func TestParsePlain(t *testing.T) {
	type Test struct {
		input  string
		output string
	}
	var tests = []Test{
		{"测试普通邮件\n\n在 2013-03-19 13:10:34，\"Googol Lee\" <googollee@gmail.com> 写道：\n\n测试普通邮件回复", "测试普通邮件"},
	}
	for i, test := range tests {
		output := parsePlain(test.input)
		assert.Equal(t, output, test.output, fmt.Sprintf("test %d", i))
	}
}

func TestParseContentType(t *testing.T) {
	type Test struct {
		contentType string
		mime        string
		pairs       string
	}
	var tests = []Test{
		{"multipart/alternative; boundary=\"----=_Part_134558_1130028024.1363669790299", "multipart/alternative", "map[boundary:----=_Part_134558_1130028024.1363669790299]"},
	}
	for i, test := range tests {
		mime, pairs := parseContentType(test.contentType)
		assert.Equal(t, mime, test.mime, fmt.Sprintf("test %d", i))
		assert.Equal(t, fmt.Sprintf("%v", pairs), test.pairs, fmt.Sprintf("test %d", i))
	}
}

func Test163(t *testing.T) {
	var str = `Received: from googollee$163.com ( [116.237.198.97] ) by
 ajax-webmail-wmsvr64 (Coremail) ; Tue, 19 Mar 2013 13:09:50 +0800 (CST)
X-Originating-IP: [116.237.198.97]
Date: Tue, 19 Mar 2013 13:09:50 +0800 (CST)
From: googollee  <googollee@163.com>
To: x+c236@0d0f.com
Subject: =?GBK?B?UmU6suLK1NPKvP60tL2oNQ==?=
X-Priority: 3
X-Mailer: Coremail Webmail Server Version SP_ntes V3.5 build
 20130201(21528.5249.5248) Copyright (c) 2002-2013 www.mailtech.cn 163com
In-Reply-To: <5147f215.87f1420a.5619.ffff95d4@mx.google.com>
References: <x+c236@exfe.com>
 <5147f215.87f1420a.5619.ffff95d4@mx.google.com>
X-CM-CTRLDATA: yAgEyWZvb3Rlcl9odG09ODA1Nzo4MQ==
Content-Type: multipart/alternative; 
	boundary="----=_Part_134558_1130028024.1363669790299"
MIME-Version: 1.0
Message-ID: <688b5ae2.8bc9.13d810dae5b.Coremail.googollee@163.com>

------=_Part_134558_1130028024.1363669790299
Content-Type: text/plain; charset=GBK
Content-Transfer-Encoding: base64

suLK1GV4ZmXTyrz+u9i4tAoKCgoKCgrU2iAyMDEzLTAzLTE5IDEzOjA1OjI1o6wiW0RFVl1FWEZF
IKGkWKGkIiA8eEAwZDBmLmNvbT4g0LS1wKO6Cgp8ILLiytTTyrz+tLS9qDUgfAp8CnwgSW52aXRh
dGlvbiBmcm9tIEdvb2dvbCBMZWUuIHwKfAp8CgpUaW1lCgpUbyBiZSBkZWNpZGVkCgp8CgpQbGFj
ZQoKVG8gYmUgZGVjaWRlZAoKfAp8CnwgSSdtIGluQ2hlY2sgaXQgb3V0Li4uIHwKfCC0tL2osKGj
oaOho6EgfAp8IHwKfCB8CnwKfCB8IEdvb2dvbCBMZWVob3N0IHwKfCB8IGdvb2dvbGxlZSB8CnwK
fAp8IFJlcGx5IHRoaXMgZW1haWwgZGlyZWN0bHkgYXMgY29udmVyc2F0aW9uLCBvciBUcnkgRVhG
RSBhcHAuClRoaXMgoaRYoaQgaW52aXRhdGlvbiBpcyBzZW50IGJ5IEdvb2dvbCBMZWUgZnJvbSBF
WEZFLiB8
------=_Part_134558_1130028024.1363669790299
Content-Type: text/html; charset=GBK
Content-Transfer-Encoding: base64

PGRpdiBzdHlsZT0ibGluZS1oZWlnaHQ6MS43O2NvbG9yOiMwMDAwMDA7Zm9udC1zaXplOjE0cHg7
Zm9udC1mYW1pbHk6YXJpYWwiPrLiytRleGZl08q8/rvYuLQ8YnI+PGJyPjxicj48YnI+PGJyPjxk
aXY+PC9kaXY+PGRpdiBpZD0iZGl2TmV0ZWFzZU1haWxDYXJkIj48L2Rpdj48YnI+1NogMjAxMy0w
My0xOSAxMzowNToyNaOsIltERVZdRVhGRSZuYnNwO6GkWKGkIiZuYnNwOyZsdDt4QDBkMGYuY29t
Jmd0OyDQtLXAo7o8YnI+IDxibG9ja3F1b3RlIGlkPSJpc1JlcGx5Q29udGVudCIgc3R5bGU9IlBB
RERJTkctTEVGVDogMWV4OyBNQVJHSU46IDBweCAwcHggMHB4IDAuOGV4OyBCT1JERVItTEVGVDog
I2NjYyAxcHggc29saWQiPgogICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgPHN0eWxlPgog
ICAgICAgICAgICAuZXhmZV9tYWlsX2xhYmVsIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQt
Y29sb3I6ICNENUU4RjI7CiAgICAgICAgICAgICAgICBjb2xvcjogIzNhNmVhNTsKICAgICAgICAg
ICAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgICAgICAgICAgIHBhZGRpbmc6IDAgMnB4IDAg
MnB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC5leGZlX21haWxfbWF0ZXMgewogICAgICAg
ICAgICAgICAgY29sb3I6ICMzYTZlYTU7CiAgICAgICAgICAgICAgICBmb250LXNpemU6IDEycHg7
CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLmV4ZmVfbWFpbF9pZGVudGl0eSB7CiAgICAgICAg
ICAgICAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLmV4
ZmVfbWFpbF9pZGVudGl0eV9uYW1lIHsKICAgICAgICAgICAgICAgIGNvbG9yOiAjMTkxOTE5Owog
ICAgICAgICAgICB9CiAgICAgICAgPC9zdHlsZT4KICAgIAogICAgCiAgICAgICAgPHRhYmxlIHdp
ZHRoPSI2NDAiIGJvcmRlcj0iMCIgY2VsbHBhZGRpbmc9IjAiIGNlbGxzcGFjaW5nPSIwIiBzdHls
ZT0iZm9udC1mYW1pbHk6IEhlbHZldGljYTsgZm9udC1zaXplOiAxM3B4OyBsaW5lLWhlaWdodDog
MTlweDsgY29sb3I6ICMxOTE5MTk7IGZvbnQtd2VpZ2h0OiBub3JtYWw7IHBhZGRpbmc6IDMwcHgg
NDBweCAzMHB4IDQwcHg7IGJhY2tncm91bmQtY29sb3I6ICNmYmZiZmI7IG1pbi1oZWlnaHQ6IDU2
MnB4OyI+CiAgICAgICAgICAgIDx0Ym9keT48dHI+CiAgICAgICAgICAgICAgICA8dGQgY29sc3Bh
bj0iMyIgdmFsaWduPSJ0b3AiIHN0eWxlPSJmb250LXNpemU6IDMycHg7IGxpbmUtaGVpZ2h0OiAz
OHB4OyBwYWRkaW5nLWJvdHRvbTogMThweDsiPgogICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9
Imh0dHA6Ly8wZDBmLmNvbS8jIXRva2VuPTkzZTA2ZjkzNDUyY2FlMzA5NmM3YzMzODg3YjI1MGRl
IiBzdHlsZT0iY29sb3I6ICMzYTZlYTU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgZm9udC13ZWln
aHQ6IDMwMDsiPgogICAgICAgICAgICAgICAgICAgICAgICCy4srU08q8/rS0vag1CiAgICAgICAg
ICAgICAgICAgICAgPC9hPgogICAgICAgICAgICAgICAgPC90ZD4KICAgICAgICAgICAgPC90cj4K
ICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRkIHdpZHRoPSIzNDAiIHN0eWxlPSJ2
ZXJ0aWNhbC1hbGlnbjogYmFzZWxpbmU7IGZvbnQtd2VpZ2h0OiAzMDA7Ij4KICAgICAgICAgICAg
ICAgICAgICA8dGFibGUgYm9yZGVyPSIwIiBjZWxscGFkZGluZz0iMCIgY2VsbHNwYWNpbmc9IjAi
PgogICAgICAgICAgICAgICAgICAgICAgICA8dGJvZHk+PHRyPgogICAgICAgICAgICAgICAgICAg
ICAgICAgICAgPHRkIHZhbGlnbj0idG9wIiBzdHlsZT0icGFkZGluZy1ib3R0b206IDIwcHg7IGZv
bnQtc2l6ZTogMjBweDsgdmVydGljYWwtYWxpZ246IGJhc2VsaW5lOyI+CiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSW52aXRh
dGlvbiBmcm9tIDxzcGFuIHN0eWxlPSJmb250LXdlaWdodDo4MDA7Ij5Hb29nb2wgTGVlPC9zcGFu
Pi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIDwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAg
ICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4KICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICA8dGFibGUgYm9yZGVyPSIwIiBjZWxscGFkZGluZz0iMCIg
Y2VsbHNwYWNpbmc9IjAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGJv
ZHk+PHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHZhbGln
bj0idG9wIiB3aWR0aD0iMTYwIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICA8YSBocmVmPSJodHRwOi8vMGQwZi5jb20vIyF0b2tlbj05M2UwNmY5MzQ1MmNhZTMw
OTZjN2MzMzg4N2IyNTBkZSIgc3R5bGU9InRleHQtZGVjb3JhdGlvbjogbm9uZTsiPgogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAkKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIDxwIHN0eWxlPSJmb250LXNpemU6IDIwcHg7IGxpbmUtaGVp
Z2h0OiAyNnB4OyBtYXJnaW46IDA7IGNvbG9yOiAjMzMzMzMzOyI+CiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaW1lCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvcD4KICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgPHAgc3R5bGU9ImNvbG9yOiAjMTkxOTE5OyBtYXJn
aW46IDA7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIFRvIGJlIGRlY2lkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgPC9wPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2E+CiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RkPgogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHZhbGlnbj0idG9wIiBzdHlsZT0icGFkZGlu
Zy1sZWZ0OiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgPGEgaHJlZj0iaHR0cDovLzBkMGYuY29tLyMhdG9rZW49OTNlMDZmOTM0NTJjYWUzMDk2Yzdj
MzM4ODdiMjUwZGUiIHN0eWxlPSJ0ZXh0LWRlY29yYXRpb246IG5vbmU7Ij4KICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwIHN0eWxlPSJmb250LXNpemU6IDIwcHg7IGxp
bmUtaGVpZ2h0OiAyNnB4OyBtYXJnaW46IDA7IGNvbG9yOiAjMzMzMzMzOyI+CiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQbGFjZQogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3A+CiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjogIzE5MTkx
OTsgbWFyZ2luOiAwOyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBUbyBiZSBkZWNpZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIDwvcD4gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IDwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+CiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgPC90Ym9keT48L3RhYmxlPgogICAgICAgICAgICAgICAgICAgICAgICAgICAg
PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAg
ICAgCiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIDx0ZCB2YWxpZ249InRvcCIgc3R5bGU9InBhZGRpbmctdG9wOiAzMHB4OyBwYWRkaW5nLWJv
dHRvbTogMzBweDsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIHN0eWxlPSJm
bG9hdDogbGVmdDsgZGlzcGxheTogYmxvY2s7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVy
OiAxcHggc29saWQgI2JlYmViZTsgYmFja2dyb3VuZC1jb2xvcjogIzNBNkVBNTsgY29sb3I6ICNG
RkZGRkY7IHBhZGRpbmc6IDVweCAzMHB4IDVweCAzMHB4OyBtYXJnaW4tbGVmdDogMjVweDsiIGFs
dD0iQWNjZXB0IiBocmVmPSJodHRwOi8vMGQwZi5jb20vP3Rva2VuPTkzZTA2ZjkzNDUyY2FlMzA5
NmM3YzMzODg3YjI1MGRlJmFtcDtyc3ZwPWFjY2VwdCI+SSdtIGluPC9hPgogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIDxhIHN0eWxlPSJmbG9hdDogbGVmdDsgZGlzcGxheTogYmxvY2s7
IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyOiAxcHggc29saWQgI2JlYmViZTsgYmFja2dy
b3VuZC1jb2xvcjogI0U2RTZFNjsgY29sb3I6ICMxOTE5MTk7IHBhZGRpbmc6IDVweCAyNXB4IDVw
eCAyNXB4OyBtYXJnaW4tbGVmdDogMTVweDsiIGFsdD0iQ2hlY2sgaXQgb3V0IiBocmVmPSJodHRw
Oi8vMGQwZi5jb20vIyF0b2tlbj05M2UwNmY5MzQ1MmNhZTMwOTZjN2MzMzg4N2IyNTBkZSI+Q2hl
Y2sgaXQgb3V0Li4uPC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4KICAgICAg
ICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAg
ICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCB2YWxp
Z249InRvcCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgtLS9qLCho6GjoaOhCiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICA8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAg
IDwvdGJvZHk+PC90YWJsZT4KICAgICAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgICAgICA8
dGQgd2lkdGg9IjMwIj48L3RkPgogICAgICAgICAgICAgICAgPHRkIHZhbGlnbj0idG9wIj4KICAg
ICAgICAgICAgICAgICAgICA8dGFibGUgYm9yZGVyPSIwIiBjZWxscGFkZGluZz0iMCIgY2VsbHNw
YWNpbmc9IjAiPgogICAgICAgICAgICAgICAgICAgICAgICA8dGJvZHk+PHRyPgogICAgICAgICAg
ICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgaGVpZ2h0
PSI2OCIgdmFsaWduPSJ0b3AiIGFsaWduPSJyaWdodCI+CiAgICAgICAgICAgICAgICAgICAgICAg
ICAgICA8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAg
ICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGFibGUg
Ym9yZGVyPSIwIiBzdHlsZT0iY29sb3I6ICMzMzMzMzM7IiBjZWxscGFkZGluZz0iMCIgY2VsbHNw
YWNpbmc9IjAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRib2R5Pjx0cj4KICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIDx0ZCB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIGFsaWduPSJs
ZWZ0IiB2YWxpZ249InRvcCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgPGltZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHRpdGxlPSJHb29nb2wgTGVlIiBhbHQ9
Ikdvb2dvbCBMZWUiIHNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyLzE1YjdmYzFi
MTAxZWUyODliODE2Nzg4MTI3ODFhZWE2Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8
dGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuPkdvb2dv
bCBMZWU8L3NwYW4+IDxzcGFuIGNsYXNzPSJleGZlX21haWxfbGFiZWwiPmhvc3Q8L3NwYW4+CiAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RkPgogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHdpZHRoPSIyNSIgaGVpZ2h0PSIy
NSIgYWxpZ249ImxlZnQiIHZhbGlnbj0idG9wIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICA8aW1nIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdGl0bGU9Imdvb2dv
bGxlZSIgYWx0PSJnb29nb2xsZWUiIHNyYz0iaHR0cDovL2FwaS4wZDBmLmNvbS92Mi9hdmF0YXIv
ZGVmYXVsdD9uYW1lPWdvb2dvbGxlZSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICA8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRk
PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj5nb29nb2xs
ZWU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RkPgog
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3Ri
b2R5PjwvdGFibGU+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RkPgogICAgICAgICAg
ICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDwvdGJvZHk+PC90YWJsZT4K
ICAgICAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgIDx0cj4K
ICAgICAgICAgICAgICAgIDx0ZCBjb2xzcGFuPSIzIiBzdHlsZT0iZm9udC1zaXplOiAxMXB4OyBs
aW5lLWhlaWdodDogMTVweDsgY29sb3I6ICM3RjdGN0Y7IHBhZGRpbmctdG9wOiA0MHB4OyI+CiAg
ICAgICAgICAgICAgICAgICAgUmVwbHkgdGhpcyBlbWFpbCBkaXJlY3RseSBhcyBjb252ZXJzYXRp
b24sIG9yIFRyeSA8YSBzdHlsZT0iY29sb3I6ICMzYTZlYTU7IHRleHQtZGVjb3JhdGlvbjogbm9u
ZTsiIGhyZWY9Imh0dHA6Ly9pdHVuZXMuYXBwbGUuY29tL3VhL2FwcC9leGZlL2lkNTE0MDI2NjA0
Ij5FWEZFPC9hPiBhcHAuCiAgICAgICAgICAgICAgICAgICAgPGJyPgogICAgICAgICAgICAgICAg
ICAgIFRoaXMgPGEgc3R5bGU9ImNvbG9yOiAjM2E2ZWE1OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7
IiBocmVmPSJodHRwOi8vMGQwZi5jb20vIyF0b2tlbj05M2UwNmY5MzQ1MmNhZTMwOTZjN2MzMzg4
N2IyNTBkZSI+oaRYoaQ8L2E+IGludml0YXRpb24gaXMgc2VudCBieSA8c3BhbiBjbGFzcz0iZXhm
ZV9tYWlsX2lkZW50aXR5X25hbWUiPkdvb2dvbCBMZWU8L3NwYW4+IGZyb20gPGEgc3R5bGU9ImNv
bG9yOiAjM2E2ZWE1OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IiBocmVmPSJodHRwOi8vMGQwZi5j
b20iPkVYRkU8L2E+LgogICAgICAgICAgICAgICAgPC90ZD4KICAgICAgICAgICAgPC90cj4KICAg
ICAgICA8L3Rib2R5PjwvdGFibGU+CiAgICAKCjwvYmxvY2txdW90ZT48L2Rpdj48YnI+PGJyPjxz
cGFuIHRpdGxlPSJuZXRlYXNlZm9vdGVyIj48c3BhbiBpZD0ibmV0ZWFzZV9tYWlsX2Zvb3RlciI+
PC9zcGFuPjwvc3Bhbj4=
------=_Part_134558_1130028024.1363669790299--`

	buf := bytes.NewBufferString(str)
	msg, err := mail.ReadMessage(buf)
	if err != nil {
		t.Fatal(err)
	}
	parser, err := NewParser(msg, &config)
	if err != nil {
		t.Fatal(err)
	}
	assert.Equal(t, parser.messageID, "688b5ae2.8bc9.13d810dae5b.Coremail.googollee@163.com")
	assert.Equal(t, parser.content, "测试exfe邮件回复")
}

func TestInit(t *testing.T) {
	var str = `Delivered-To: panda@0d0f.com
Received: by 10.70.0.234 with SMTP id 10csp193484pdh;
        Sun, 17 Mar 2013 23:15:37 -0700 (PDT)
X-Received: by 10.152.113.34 with SMTP id iv2mr13078933lab.20.1363587335984;
        Sun, 17 Mar 2013 23:15:35 -0700 (PDT)
Return-Path: <googollee@hotmail.com>
Received: from bay0-omc2-s22.bay0.hotmail.com (bay0-omc2-s22.bay0.hotmail.com. [65.54.190.97])
        by mx.google.com with ESMTP id ia4si6157124lab.180.2013.03.17.23.15.34;
        Sun, 17 Mar 2013 23:15:35 -0700 (PDT)
Received-SPF: pass (google.com: domain of googollee@hotmail.com designates 65.54.190.97 as permitted sender) client-ip=65.54.190.97;
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of googollee@hotmail.com designates 65.54.190.97 as permitted sender) smtp.mail=googollee@hotmail.com
Received: from BAY152-DS11 ([65.54.190.124]) by bay0-omc2-s22.bay0.hotmail.com with Microsoft SMTPSVC(6.0.3790.4675);
	 Sun, 17 Mar 2013 23:15:34 -0700
X-EIP: [cqX6eeEhbwCCOhFZWRs2ZHcUKc1BKGRH]
X-Originating-Email: [googollee@hotmail.com]
Message-ID: <BAY152-ds11D2686FF50F86678FFD1AA0E80@phx.gbl>
Return-Path: googollee@hotmail.com
From: "Lee Googol Lee" <googollee@hotmail.com>
To: googollee@gmail.com;panda@0d0f.com
Date: Sun, 17 Mar 2013 23:15:33 -0700
Subject: =?utf-8?B?5rS75Yqo?=
Content-Type: multipart/alternative;
	boundary="_32936406-5bb3-4fc0-b17a-11cc15875002_"
MIME-Version: 1.0
X-OriginalArrivalTime: 18 Mar 2013 06:15:34.0264 (UTC) FILETIME=[0008CF80:01CE23A0]

--_32936406-5bb3-4fc0-b17a-11cc15875002_
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64


--_32936406-5bb3-4fc0-b17a-11cc15875002_
Content-Type: text/html; charset="utf-8"
Content-Transfer-Encoding: base64

DQoNCjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+DQogICAgDQogICAgDQogICAgLk1haW5Db250YWlu
ZXINCiAgICB7DQogICAgICAgIGZvbnQtZmFtaWx5OiA7IC8qIFRoZSB0b3RhbCB3aWR0aCBpcyA3
MDBweCwgd2hpY2ggd2UgZ2V0IGJ5IGhhdmluZyBwYWRkaW5nIG9mIDUwcHggb24gZWFjaCBsZWZ0
IGFuZCByaWdodCBzaWRlIGFuZCBhIDYwMCB3aWR0aCBzZXR0aW5nICovDQogICAgICAgIGJhY2tn
cm91bmQtY29sb3I6ICNFNkU2RTY7DQogICAgfQ0KDQogICAgLk1haW5WZXJ0aWNhbEJvcmRlcg0K
ICAgIHsNCiAgICAgICAgd2lkdGg6IDUwcHg7DQogICAgfQ0KICAgIC5NYWluSG9yaXpvbnRhbEJv
cmRlcg0KICAgIHsNCiAgICAgICAgaGVpZ2h0OiAyMHB4Ow0KICAgIH0NCiAgICANCiAgICAuSW5u
ZXJIb3Jpem9udGFsQm9yZGVyDQogICAgew0KICAgICAgICBoZWlnaHQ6IDIwcHg7DQogICAgfQ0K
ICAgIC5Jbm5lclZlcnRpY2FsQm9yZGVyDQogICAgew0KICAgICAgICB3aWR0aDogNDBweDsNCiAg
ICAgICAgYmFja2dyb3VuZC1jb2xvcjogI0ZGRkZGRjsgICAgICAgIA0KICAgIH0NCiAgICAuQ29u
dGVudENvbnRhaW5lcg0KICAgIHsNCiAgICAgICAgd2lkdGg6IDUyMHB4Ow0KICAgICAgICBiYWNr
Z3JvdW5kLWNvbG9yOiAjRkZGRkZGOyAgICAgICAgDQogICAgfQ0KICAgIA0KICAgIC5Jbm5lclZl
cnRpY2FsQm9yZGVyV2lkdGgNCiAgICB7DQogICAgICAgIHdpZHRoOiA0MHB4Ow0KICAgIH0NCiAg
ICAuQ29udGVudFdpZHRoDQogICAgew0KICAgICAgICB3aWR0aDogNTIwcHg7DQogICAgfQ0KICAg
IA0KICAgIC5Gb290ZXJDb250YWluZXINCiAgICB7DQogICAgICAgIHRleHQtYWxpZ246IHJpZ2h0
Ow0KICAgIH0NCjwvc3R5bGU+DQoNCg0KPHRhYmxlIGNlbGxwYWRkaW5nPSIwIiBjZWxsc3BhY2lu
Zz0iMCIgY2xhc3M9Ik1haW5Db250YWluZXIiPg0KICAgIDx0ciBjbGFzcz0iTWFpbkhvcml6b250
YWxCb3JkZXIiPg0KICAgICAgICA8dGQgY2xhc3M9Ik1haW5WZXJ0aWNhbEJvcmRlciI+PC90ZD4g
ICAgDQogICAgICAgIDx0ZCBjbGFzcz0iSW5uZXJWZXJ0aWNhbEJvcmRlcldpZHRoIj48L3RkPg0K
ICAgICAgICA8dGQgY2xhc3M9IkNvbnRlbnRXaWR0aCI+PC90ZD4NCiAgICAgICAgPHRkIGNsYXNz
PSJJbm5lclZlcnRpY2FsQm9yZGVyV2lkdGgiPjwvdGQ+DQogICAgICAgIDx0ZCBjbGFzcz0iTWFp
blZlcnRpY2FsQm9yZGVyIj48L3RkPiAgICAgICAgDQogICAgPC90cj4NCiAgICA8dHIgY2xhc3M9
IklubmVySG9yaXpvbnRhbEJvcmRlciI+DQogICAgICAgIDx0ZCBjbGFzcz0iTWFpblZlcnRpY2Fs
Qm9yZGVyIj48L3RkPg0KICAgICAgICA8dGQgY2xhc3M9IklubmVyVmVydGljYWxCb3JkZXIiPjwv
dGQ+DQogICAgICAgIDx0ZCBjbGFzcz0iQ29udGVudENvbnRhaW5lciI+PC90ZD4NCiAgICAgICAg
PHRkIGNsYXNzPSJJbm5lclZlcnRpY2FsQm9yZGVyIj48L3RkPg0KICAgICAgICA8dGQgY2xhc3M9
Ik1haW5WZXJ0aWNhbEJvcmRlciI+PC90ZD4NCiAgICA8L3RyPg0KICAgIDx0cj4NCiAgICAgICAg
PHRkIGNsYXNzPSJNYWluVmVydGljYWxCb3JkZXIiPjwvdGQ+DQogICAgICAgIDx0ZCBjbGFzcz0i
SW5uZXJWZXJ0aWNhbEJvcmRlciI+PC90ZD4NCiAgICAgICAgPHRkIGNsYXNzPSJDb250ZW50Q29u
dGFpbmVyIj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9IkNvbnRlbnRDb250YWluZXIiPg0KICAg
ICAgICAgICAgICAgIA0KDQo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KICAgIA0KICAgIC5NZWV0
aW5nUmVxdWVzdEhlYWRlcg0KICAgIHsNCiAgICAgICAgZm9udC1zaXplOiAyMnB4Ow0KICAgICAg
ICBmb250LXdlaWdodDpib2xkOw0KICAgICAgICBjb2xvcjojNDQ0NDQ0Ow0KICAgIH0NCiAgICAu
TWVldGluZ1JlcXVlc3RNZXNzYWdlQ29udGFpbmVyDQogICAgew0KICAgICAgICBwYWRkaW5nLXRv
cDoxNnB4Ow0KICAgIH0NCiAgICAuTWVldGluZ1JlcXVlc3RNZXNzYWdlDQogICAgew0KICAgICAg
ICBmb250LXNpemU6IDIycHg7DQogICAgICAgIGNvbG9yOiNGNDc5M0E7DQogICAgfQ0KICAgIC5N
ZWV0aW5nUmVxdWVzdFF1b3RlDQogICAgew0KICAgICAgICBmb250LWZhbWlseTogOw0KICAgICAg
ICBmb250LXdlaWdodDpib2xkOw0KICAgICAgICBmb250LXNpemU6MjRwdDsNCiAgICAgICAgY29s
b3I6Izg4ODg4ODsNCiAgICB9DQogICAgLk1lZXRpbmdSZXF1ZXN0RGVzY3JpcHRpb24NCiAgICB7
DQogICAgICAgIGZvbnQtZmFtaWx5OiA7DQogICAgICAgIGNvbG9yOiM0NDQ0NDQ7DQogICAgICAg
IGZvbnQtc2l6ZToxM3B4Ow0KICAgIH0NCiAgICAuTWVldGluZ1JlcXVlc3RIUnVsZQ0KICAgIHsN
CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI0VCRUJFQjsNCiAgICAgICAgZm9udC1zaXplOiAx
cHg7DQogICAgICAgIGhlaWdodDoxcHg7DQogICAgICAgIHdpZHRoOjEwMCU7DQogICAgICAgIG1h
cmdpbjoxNnB4IDBweDsNCiAgICB9DQogICAgLk1lZXRpbmdSZXF1ZXN0VGFibGUNCiAgICB7DQog
ICAgICAgIHdpZHRoOjEwMCU7DQogICAgICAgIGJvcmRlci1jb2xsYXBzZTpjb2xsYXBzZTsNCiAg
ICB9DQogICAgLk1lZXRpbmdSZXF1ZXN0VGFibGUgVEQNCiAgICB7DQogICAgICAgIHBhZGRpbmct
dG9wOjE2cHg7DQogICAgfQ0KICAgIC5NZWV0aW5nUmVxdWVzdFRpbWVMb2NhdGlvbkNvbnRhaW5l
cg0KICAgIHsNCiAgICAgICAgZm9udC1zaXplOjE2cHg7DQogICAgICAgIGNvbG9yOiM4ODg4ODg7
DQogICAgICAgIHdpZHRoOjEwMCU7DQogICAgfQ0KICAgIC5NZWV0aW5nUmVxdWVzdENhbmNlbA0K
ICAgIHsNCiAgICAgICAgaGVpZ2h0OjQ4cHg7DQogICAgICAgIHdpZHRoOjQ4cHg7DQogICAgICAg
IG1hcmdpbi1yaWdodDoxMnB4Ow0KICAgIH0NCiAgICANCjwvc3R5bGU+DQoNCjxkaXYgY2xhc3M9
Ik1lZXRpbmdSZXF1ZXN0SGVhZGVyIj5MZWUgR29vZ29sIExlZSDlkJHkvaDlj5HpgIHkuobigJwm
IzI3OTYzOyYjMjExNjA74oCd55qE6YKA6K+3PC9kaXY+DQo8dGFibGUgY2xhc3M9Ik1lZXRpbmdS
ZXF1ZXN0VGFibGUiPg0KICAgIDx0cj4NCiAgICA8dGQgY2xhc3M9Ik1lZXRpbmdSZXF1ZXN0VGlt
ZUxvY2F0aW9uQ29udGFpbmVyIj4NCiAgICAgICAgPGRpdj4yMDEz5bm0M+aciDE55pelPC9kaXY+
PGRpdj7kuIrljYg5OjAwIC0g5LiK5Y2IMTA6MDA8L2Rpdj4NCiAgICAgICAgPGRpdj4mIzIyMzIw
OyYjMjg4NTc7PC9kaXY+DQogICAgPC90ZD4NCiAgICA8L3RyPg0KPC90YWJsZT4NCg0KDQo8dGFi
bGUgY2xhc3M9Ik1lZXRpbmdSZXF1ZXN0VGFibGUiPg0KICAgIDx0cj4NCiAgICA8dGQgY2xhc3M9
Ik1lZXRpbmdSZXF1ZXN0VGltZUxvY2F0aW9uQ29udGFpbmVyIj48ZGl2PuatpOa0u+WKqOWPkeeU
n+S6jiAoR01UKzA4OjAwKSDljJfkuqzvvIzph43luobvvIzpppnmuK/nibnliKvooYzmlL/ljLrv
vIzkuYzpsoHmnKjpvZA8L2Rpdj48L3RkPg0KICAgIDwvdHI+DQo8L3RhYmxlPg0KPGRpdiBjbGFz
cz0iTWVldGluZ1JlcXVlc3RIUnVsZSI+PC9kaXY+DQoNCiAgICAgICAgICAgIDwvZGl2Pg0KICAg
ICAgICAgICAgPGJyIC8+DQogICAgICAgICAgICA8ZGl2IGNsYXNzPSJGb290ZXJDb250YWluZXIi
Pg0KICAgICAgICAgICAgICAgIDxpbWcgc3JjPSJodHRwczovL2dmeDUuaG90bWFpbC5jb20vY2Fs
LzExLjAwL3VwZGF0ZWJldGEvbHRyL2xvZ29fd2xfaG90bWFpbF8xMjAuZ2lmIiBhbHQ9IldpbmRv
d3MgTGl2ZSI+PC9pbWc+IA0KICAgICAgICAgICAgPC9kaXY+DQogICAgICAgIDwvdGQ+DQogICAg
ICAgIDx0ZCBjbGFzcz0iSW5uZXJWZXJ0aWNhbEJvcmRlciI+PC90ZD4NCiAgICAgICAgPHRkIGNs
YXNzPSJNYWluVmVydGljYWxCb3JkZXIiPjwvdGQ+DQogICAgPC90cj4NCiAgICA8dHIgY2xhc3M9
IklubmVySG9yaXpvbnRhbEJvcmRlciI+DQogICAgICAgIDx0ZCBjbGFzcz0iTWFpblZlcnRpY2Fs
Qm9yZGVyIj48L3RkPg0KICAgICAgICA8dGQgY2xhc3M9IklubmVyVmVydGljYWxCb3JkZXIiPjwv
dGQ+DQogICAgICAgIDx0ZCBjbGFzcz0iQ29udGVudENvbnRhaW5lciI+PC90ZD4NCiAgICAgICAg
PHRkIGNsYXNzPSJJbm5lclZlcnRpY2FsQm9yZGVyIj48L3RkPg0KICAgICAgICA8dGQgY2xhc3M9
Ik1haW5WZXJ0aWNhbEJvcmRlciI+PC90ZD4NCiAgICA8L3RyPg0KICAgIDx0ciBjbGFzcz0iTWFp
bkhvcml6b250YWxCb3JkZXIiPg0KICAgICAgICA8dGQgY2xhc3M9Ik1haW5WZXJ0aWNhbEJvcmRl
ciI+PC90ZD4gICAgDQogICAgICAgIDx0ZCBjbGFzcz0iSW5uZXJWZXJ0aWNhbEJvcmRlcldpZHRo
Ij48L3RkPg0KICAgICAgICA8dGQgY2xhc3M9IkNvbnRlbnRXaWR0aCI+PC90ZD4NCiAgICAgICAg
PHRkIGNsYXNzPSJJbm5lclZlcnRpY2FsQm9yZGVyV2lkdGgiPjwvdGQ+DQogICAgICAgIDx0ZCBj
bGFzcz0iTWFpblZlcnRpY2FsQm9yZGVyIj48L3RkPiAgICAgICAgDQogICAgPC90cj4NCjwvdGFi
bGU+DQo=

--_32936406-5bb3-4fc0-b17a-11cc15875002_
Content-Type: text/calendar; charset="utf-8"; method=REQUEST
Content-Transfer-Encoding: base64

QkVHSU46VkNBTEVOREFSDQpNRVRIT0Q6UkVRVUVTVA0KVkVSU0lPTjoyLjANClBST0RJRDotLy9N
aWNyb3NvZnQgQ29ycG9yYXRpb24vL1dpbmRvd3MgTGl2ZSBDYWxlbmRhci8vRU4NCkJFR0lOOlZU
SU1FWk9ORQ0KVFpJRDpDaGluYSBTdGFuZGFyZCBUaW1lDQpCRUdJTjpTVEFOREFSRA0KRFRTVEFS
VDoyMDA4MDEwMVQwMDAwMDANClRaT0ZGU0VUVE86KzA4MDANClRaT0ZGU0VURlJPTTorMDgwMA0K
RU5EOlNUQU5EQVJEDQpFTkQ6VlRJTUVaT05FDQpCRUdJTjpWRVZFTlQNClVJRDpiZTcxYWUxNS01
NjY0LTQ1MWEtODRiMy1hMzFjM2Y1NWFjZmMNCkRUU1RBTVA6MjAxMzAzMThUMDYxNTMzWg0KQ0xB
U1M6UFVCTElDDQpYLU1JQ1JPU09GVC1DRE8tQlVTWVNUQVRVUzpCVVNZDQpUUkFOU1A6T1BBUVVF
DQpTRVFVRU5DRTowDQpEVFNUQVJUO1RaSUQ9Q2hpbmEgU3RhbmRhcmQgVGltZToyMDEzMDMxOVQw
OTAwMDANCkRURU5EO1RaSUQ9Q2hpbmEgU3RhbmRhcmQgVGltZToyMDEzMDMxOVQxMDAwMDANClNV
TU1BUlk65rS75YqoDQpMT0NBVElPTjrlnLDngrkNClBSSU9SSVRZOjANCkFUVEVOREVFO0NVVFlQ
RT1JTkRJVklEVUFMO1JPTEU9UkVRLVBBUlRJQ0lQQU5UO1BBUlRTVEFUPU5FRURTLUFDVElPTjtS
U1ZQPQ0KIFRSVUU6TUFJTFRPOmdvb2dvbGxlZUBnbWFpbC5jb20NCkFUVEVOREVFO0NVVFlQRT1J
TkRJVklEVUFMO1JPTEU9UkVRLVBBUlRJQ0lQQU5UO1BBUlRTVEFUPU5FRURTLUFDVElPTjtSU1ZQ
PQ0KIFRSVUU6TUFJTFRPOnBhbmRhQDBkMGYuY29tDQpPUkdBTklaRVI7Q049TGVlIEdvb2dvbCBM
ZWU6TUFJTFRPOmdvb2dvbGxlZUBob3RtYWlsLmNvbQ0KQkVHSU46VkFMQVJNDQpBQ1RJT046RElT
UExBWQ0KVFJJR0dFUjotUFQxNU0NCkVORDpWQUxBUk0NCkJFR0lOOlZBTEFSTQ0KQUNUSU9OOkRJ
U1BMQVkNClRSSUdHRVI6LVBUMTVNDQpFTkQ6VkFMQVJNDQpFTkQ6VkVWRU5UDQpFTkQ6VkNBTEVO
REFSDQo=

--_32936406-5bb3-4fc0-b17a-11cc15875002_--`

	buf := bytes.NewBufferString(str)
	msg, err := mail.ReadMessage(buf)
	if err != nil {
		t.Fatal(err)
	}
	parser, err := NewParser(msg, &config)
	if err != nil {
		t.Fatal(err)
	}
	assert.Equal(t, parser.messageID, "BAY152-ds11D2686FF50F86678FFD1AA0E80@phx.gbl")
}
